<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.doudoudrive.commonservice.dao.LogOpDao">

    <!-- 实体映射 -->
    <resultMap type="com.doudoudrive.common.model.pojo.LogOp" id="logOpResultMap">
        <id property="autoId" column="auto_id"/>
        <result property="businessId" column="business_id"/>
        <result property="ip" column="ip"/>
        <result property="location" column="location"/>
        <result property="businessType" column="business_type"/>
        <result property="className" column="class_name"/>
        <result property="methodName" column="method_name"/>
        <result property="parameter" column="parameter"/>
        <result property="spider" column="spider"/>
        <result property="os" column="os"/>
        <result property="platform" column="platform"/>
        <result property="browser" column="browser"/>
        <result property="browserVersion" column="browser_version"/>
        <result property="browserEngine" column="browser_engine"/>
        <result property="browserEngineVersion" column="browser_engine_version"/>
        <result property="method" column="method"/>
        <result property="userAgent" column="user_agent"/>
        <result property="mobile" column="is_mobile"/>
        <result property="requestUri" column="request_uri"/>
        <result property="referer" column="referer"/>
        <result property="title" column="title"/>
        <result property="errorMsg" column="error_msg"/>
        <result property="errorCause" column="error_cause"/>
        <result property="success" column="is_success"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
        <result property="username" column="username"/>
    </resultMap>

    <!-- sql字段信息 -->
    <sql id="logOp">
        `auto_id`,`business_id`,INET_NTOA(`ip`) as ip,`location`,`business_type`,`class_name`,`method_name`,`parameter`,`spider`,`os`,`platform`,
        `browser`,`browser_version`,`browser_engine`,`browser_engine_version`,`method`,`user_agent`,`is_mobile`,`request_uri`,
        `referer`,`title`,`error_msg`,`error_cause`,`is_success`,`create_time`,`update_time`,`username`
    </sql>

    <!-- 搜索的参数块 -->
    <sql id="searchCondition">
        <if test="null != logOp">
            <if test="null != logOp.autoId and 0 != logOp.autoId">
                `auto_id` = #{logOp.autoId} AND
            </if>
            <if test="null != logOp.businessId and '' != logOp.businessId">
                `business_id` = #{logOp.businessId} AND
            </if>
            <if test="null != logOp.ip and '' != logOp.ip">
                `ip` = INET_ATON(#{logOp.ip}) AND
            </if>
            <if test="null != logOp.location and '' != logOp.location">
                LOCATE(#{logOp.location}, `location`)>0 AND
            </if>
            <if test="null != logOp.businessType and '' != logOp.businessType">
                LOCATE(#{logOp.businessType}, `business_type`)>0 AND
            </if>
            <if test="null != logOp.className and '' != logOp.className">
                LOCATE(#{logOp.className}, `class_name`)>0 AND
            </if>
            <if test="null != logOp.methodName and '' != logOp.methodName">
                LOCATE(#{logOp.methodName}, `method_name`)>0 AND
            </if>
            <if test="null != logOp.parameter and '' != logOp.parameter">
                `parameter` = #{logOp.parameter} AND
            </if>
            <if test="null != logOp.spider and '' != logOp.spider">
                LOCATE(#{logOp.spider}, `spider`)>0 AND
            </if>
            <if test="null != logOp.os and '' != logOp.os">
                LOCATE(#{logOp.os}, `os`)>0 AND
            </if>
            <if test="null != logOp.platform and '' != logOp.platform">
                LOCATE(#{logOp.platform}, `platform`)>0 AND
            </if>
            <if test="null != logOp.browser and '' != logOp.browser">
                LOCATE(#{logOp.browser}, `browser`)>0 AND
            </if>
            <if test="null != logOp.browserVersion and '' != logOp.browserVersion">
                LOCATE(#{logOp.browserVersion}, `browser_version`)>0 AND
            </if>
            <if test="null != logOp.browserEngine and '' != logOp.browserEngine">
                LOCATE(#{logOp.browserEngine}, `browser_engine`)>0 AND
            </if>
            <if test="null != logOp.browserEngineVersion and '' != logOp.browserEngineVersion">
                LOCATE(#{logOp.browserEngineVersion}, `browser_engine_version`)>0 AND
            </if>
            <if test="null != logOp.method and '' != logOp.method">
                LOCATE(#{logOp.method}, `method`)>0 AND
            </if>
            <if test="null != logOp.userAgent and '' != logOp.userAgent">
                LOCATE(#{logOp.userAgent}, `user_agent`)>0 AND
            </if>
            <if test="null != logOp.mobile">
                `is_mobile` = #{logOp.mobile} AND
            </if>
            <if test="null != logOp.requestUri and '' != logOp.requestUri">
                LOCATE(#{logOp.requestUri}, `request_uri`)>0 AND
            </if>
            <if test="null != logOp.referer and '' != logOp.referer">
                LOCATE(#{logOp.referer}, `referer`)>0 AND
            </if>
            <if test="null != logOp.title and '' != logOp.title">
                LOCATE(#{logOp.title}, `title`)>0 AND
            </if>
            <if test="null != logOp.errorMsg and '' != logOp.errorMsg">
                LOCATE(#{logOp.errorMsg}, `error_msg`)>0 AND
            </if>
            <if test="null != logOp.errorCause and '' != logOp.errorCause">
                LOCATE(#{logOp.errorCause}, `error_cause`)>0 AND
            </if>
            <if test="null != logOp.success">
                `is_success` = #{logOp.success} AND
            </if>
            <if test="null != logOp.username and '' != logOp.username">
                LOCATE(#{logOp.username}, `username`)>0 AND
            </if>
        </if>
        <if test="null != startTime and null != endTime">
            STR_TO_DATE(`create_time`,'%Y-%m-%d') &lt;= STR_TO_DATE(#{startTime},'%Y-%m-%d') and
            STR_TO_DATE(`create_time`,'%Y-%m-%d') >= STR_TO_DATE(#{endTime},'%Y-%m-%d') and
        </if>
    </sql>


    <!-- 新增API操作日志 -->
    <insert id="insert" parameterType="com.doudoudrive.common.model.pojo.LogOp" flushCache="true"
            useGeneratedKeys="true" keyProperty="autoId">
        INSERT INTO
        `log_op_${@cn.hutool.core.date.DateUtil@format(new java.util.Date(),"yyyyMM")}` (
        <trim suffixOverrides=",">
            <if test="null != businessId and '' != businessId">`business_id`,</if>
            <if test="null != ip and '' != ip">`ip`,</if>
            <if test="null != location and '' != location">`location`,</if>
            <if test="null != businessType and '' != businessType">`business_type`,</if>
            <if test="null != className and '' != className">`class_name`,</if>
            <if test="null != methodName and '' != methodName">`method_name`,</if>
            <if test="null != parameter and '' != parameter">`parameter`,</if>
            <if test="null != spider and '' != spider">`spider`,</if>
            <if test="null != os and '' != os">`os`,</if>
            <if test="null != platform and '' != platform">`platform`,</if>
            <if test="null != browser and '' != browser">`browser`,</if>
            <if test="null != browserVersion and '' != browserVersion">`browser_version`,</if>
            <if test="null != browserEngine and '' != browserEngine">`browser_engine`,</if>
            <if test="null != browserEngineVersion and '' != browserEngineVersion">`browser_engine_version`,</if>
            <if test="null != method and '' != method">`method`,</if>
            <if test="null != userAgent and '' != userAgent">`user_agent`,</if>
            <if test="null != mobile">`is_mobile`,</if>
            <if test="null != requestUri and '' != requestUri">`request_uri`,</if>
            <if test="null != referer and '' != referer">`referer`,</if>
            <if test="null != title and '' != title">`title`,</if>
            <if test="null != errorMsg and '' != errorMsg">`error_msg`,</if>
            <if test="null != errorCause and '' != errorCause">`error_cause`,</if>
            <if test="null != success">`is_success`,</if>
            <if test="null != username and '' != username">`username`</if>
        </trim>
        )
        VALUES
        (
        <trim suffixOverrides=",">
            <if test="null != businessId and '' != businessId">#{businessId},</if>
            <if test="null != ip and '' != ip">INET_ATON(#{ip}),</if>
            <if test="null != location and '' != location">#{location},</if>
            <if test="null != businessType and '' != businessType">#{businessType},</if>
            <if test="null != className and '' != className">#{className},</if>
            <if test="null != methodName and '' != methodName">#{methodName},</if>
            <if test="null != parameter and '' != parameter">#{parameter},</if>
            <if test="null != spider and '' != spider">#{spider},</if>
            <if test="null != os and '' != os">#{os},</if>
            <if test="null != platform and '' != platform">#{platform},</if>
            <if test="null != browser and '' != browser">#{browser},</if>
            <if test="null != browserVersion and '' != browserVersion">#{browserVersion},</if>
            <if test="null != browserEngine and '' != browserEngine">#{browserEngine},</if>
            <if test="null != browserEngineVersion and '' != browserEngineVersion">#{browserEngineVersion},</if>
            <if test="null != method and '' != method">#{method},</if>
            <if test="null != userAgent and '' != userAgent">#{userAgent},</if>
            <if test="null != mobile">#{mobile},</if>
            <if test="null != requestUri and '' != requestUri">#{requestUri},</if>
            <if test="null != referer and '' != referer">#{referer},</if>
            <if test="null != title and '' != title">#{title},</if>
            <if test="null != errorMsg and '' != errorMsg">#{errorMsg},</if>
            <if test="null != errorCause and '' != errorCause">#{errorCause},</if>
            <if test="null != success">#{success},</if>
            <if test="null != username and '' != username">#{username}</if>
        </trim>
        )
    </insert>

    <!-- 批量新增API操作日志 -->
    <insert id="insertBatch" parameterType="java.util.List" flushCache="true">
        INSERT INTO
        `log_op` (
        `business_id`,`ip`,`location`,`business_type`,`class_name`,`method_name`,
        `parameter`,`spider`,`os`,`platform`,`browser`,`browser_version`,`browser_engine`,
        `browser_engine_version`,`method`,`user_agent`,`is_mobile`,`request_uri`,`referer`,`title`,
        `error_msg`,`error_cause`,`is_success`,`username`
        )
        VALUES
        <foreach collection="list" item="item" index="index" separator=",">
            (
            #{item.businessId},INET_ATON(#{item.ip}),#{item.location},#{item.businessType},#{item.className},#{item.methodName},
            #{item.parameter},#{item.spider},#{item.os},#{item.platform},#{item.browser},#{item.browserVersion},#{item.browserEngine},
            #{item.browserEngineVersion},#{item.method},#{item.userAgent},#{item.mobile},#{item.requestUri},#{item.referer},#{item.title},
            #{item.errorMsg},#{item.errorCause},#{item.success},#{item.username}
            )
        </foreach>
    </insert>

    <!-- 根据业务id(businessId)删除API操作日志 -->
    <delete id="delete" parameterType="java.lang.String" flushCache="true">
        DELETE FROM `log_op`
        <where>
            `business_id` = #{businessId}
        </where>
    </delete>

    <!-- 根据业务id(businessId)批量删除API操作日志 -->
    <delete id="deleteBatch" parameterType="java.util.List" flushCache="true">
        DELETE FROM `log_op`
        <where>
            `business_id` IN
            <foreach collection="list" index="index" item="item" open="(" close=")" separator=",">
                #{item}
            </foreach>
        </where>
    </delete>

    <!-- 根据业务id(businessId)修改API操作日志 -->
    <update id="update" parameterType="com.doudoudrive.common.model.pojo.LogOp" flushCache="true">
        UPDATE `log_op`
        <trim prefix="SET" suffixOverrides=",">
            <if test="null != ip and '' != ip">`ip` = INET_ATON(#{ip}),</if>
            <if test="null != location and '' != location">`location` = #{location},</if>
            <if test="null != businessType and '' != businessType">`business_type` = #{businessType},</if>
            <if test="null != className and '' != className">`class_name` = #{className},</if>
            <if test="null != methodName and '' != methodName">`method_name` = #{methodName},</if>
            <if test="null != parameter and '' != parameter">`parameter` = #{parameter},</if>
            <if test="null != spider and '' != spider">`spider` = #{spider},</if>
            <if test="null != os and '' != os">`os` = #{os},</if>
            <if test="null != platform and '' != platform">`platform` = #{platform},</if>
            <if test="null != browser and '' != browser">`browser` = #{browser},</if>
            <if test="null != browserVersion and '' != browserVersion">`browser_version` = #{browserVersion},</if>
            <if test="null != browserEngine and '' != browserEngine">`browser_engine` = #{browserEngine},</if>
            <if test="null != browserEngineVersion and '' != browserEngineVersion">`browser_engine_version` =
                #{browserEngineVersion},
            </if>
            <if test="null != method and '' != method">`method` = #{method},</if>
            <if test="null != userAgent and '' != userAgent">`user_agent` = #{userAgent},</if>
            <if test="null != mobile">`is_mobile` = #{mobile},</if>
            <if test="null != requestUri and '' != requestUri">`request_uri` = #{requestUri},</if>
            <if test="null != referer and '' != referer">`referer` = #{referer},</if>
            <if test="null != title and '' != title">`title` = #{title},</if>
            <if test="null != errorMsg and '' != errorMsg">`error_msg` = #{errorMsg},</if>
            <if test="null != errorCause and '' != errorCause">`error_cause` = #{errorCause},</if>
            <if test="null != success">`is_success` = #{success},</if>
            <if test="null != username and '' != username">`username` = #{username}</if>
        </trim>
        <where>
            `business_id` = #{businessId}
        </where>
    </update>

    <!-- 根据业务id(businessId)批量修改API操作日志 -->
    <update id="updateBatch" parameterType="java.util.List" flushCache="true">
        UPDATE `log_op`
        <trim prefix="SET" suffixOverrides=",">
            <trim prefix="`ip` = case" suffix="end,">
                <foreach collection="list" item="item" index="index">
                    <if test="null != item.ip and '' != item.ip">
                        WHEN `business_id` = #{item.businessId} THEN INET_ATON(#{item.ip})
                    </if>
                </foreach>
            </trim>
            <trim prefix="`location` = case" suffix="end,">
                <foreach collection="list" item="item" index="index">
                    <if test="null != item.location and '' != item.location">
                        WHEN `business_id` = #{item.businessId} THEN #{item.location}
                    </if>
                </foreach>
            </trim>
            <trim prefix="`business_type` = case" suffix="end,">
                <foreach collection="list" item="item" index="index">
                    <if test="null != item.businessType and '' != item.businessType">
                        WHEN `business_id` = #{item.businessId} THEN #{item.businessType}
                    </if>
                </foreach>
            </trim>
            <trim prefix="`class_name` = case" suffix="end,">
                <foreach collection="list" item="item" index="index">
                    <if test="null != item.className and '' != item.className">
                        WHEN `business_id` = #{item.businessId} THEN #{item.className}
                    </if>
                </foreach>
            </trim>
            <trim prefix="`method_name` = case" suffix="end,">
                <foreach collection="list" item="item" index="index">
                    <if test="null != item.methodName and '' != item.methodName">
                        WHEN `business_id` = #{item.businessId} THEN #{item.methodName}
                    </if>
                </foreach>
            </trim>
            <trim prefix="`parameter` = case" suffix="end,">
                <foreach collection="list" item="item" index="index">
                    <if test="null != item.parameter and '' != item.parameter">
                        WHEN `business_id` = #{item.businessId} THEN #{item.parameter}
                    </if>
                </foreach>
            </trim>
            <trim prefix="`spider` = case" suffix="end,">
                <foreach collection="list" item="item" index="index">
                    <if test="null != item.spider and '' != item.spider">
                        WHEN `business_id` = #{item.businessId} THEN #{item.spider}
                    </if>
                </foreach>
            </trim>
            <trim prefix="`os` = case" suffix="end,">
                <foreach collection="list" item="item" index="index">
                    <if test="null != item.os and '' != item.os">
                        WHEN `business_id` = #{item.businessId} THEN #{item.os}
                    </if>
                </foreach>
            </trim>
            <trim prefix="`platform` = case" suffix="end,">
                <foreach collection="list" item="item" index="index">
                    <if test="null != item.platform and '' != item.platform">
                        WHEN `business_id` = #{item.businessId} THEN #{item.platform}
                    </if>
                </foreach>
            </trim>
            <trim prefix="`browser` = case" suffix="end,">
                <foreach collection="list" item="item" index="index">
                    <if test="null != item.browser and '' != item.browser">
                        WHEN `business_id` = #{item.businessId} THEN #{item.browser}
                    </if>
                </foreach>
            </trim>
            <trim prefix="`browser_version` = case" suffix="end,">
                <foreach collection="list" item="item" index="index">
                    <if test="null != item.browserVersion and '' != item.browserVersion">
                        WHEN `business_id` = #{item.businessId} THEN #{item.browserVersion}
                    </if>
                </foreach>
            </trim>
            <trim prefix="`browser_engine` = case" suffix="end,">
                <foreach collection="list" item="item" index="index">
                    <if test="null != item.browserEngine and '' != item.browserEngine">
                        WHEN `business_id` = #{item.businessId} THEN #{item.browserEngine}
                    </if>
                </foreach>
            </trim>
            <trim prefix="`browser_engine_version` = case" suffix="end,">
                <foreach collection="list" item="item" index="index">
                    <if test="null != item.browserEngineVersion and '' != item.browserEngineVersion">
                        WHEN `business_id` = #{item.businessId} THEN #{item.browserEngineVersion}
                    </if>
                </foreach>
            </trim>
            <trim prefix="`method` = case" suffix="end,">
                <foreach collection="list" item="item" index="index">
                    <if test="null != item.method and '' != item.method">
                        WHEN `business_id` = #{item.businessId} THEN #{item.method}
                    </if>
                </foreach>
            </trim>
            <trim prefix="`user_agent` = case" suffix="end,">
                <foreach collection="list" item="item" index="index">
                    <if test="null != item.userAgent and '' != item.userAgent">
                        WHEN `business_id` = #{item.businessId} THEN #{item.userAgent}
                    </if>
                </foreach>
            </trim>
            <trim prefix="`is_mobile` = case" suffix="end,">
                <foreach collection="list" item="item" index="index">
                    <if test="null != item.mobile">
                        WHEN `business_id` = #{item.businessId} THEN #{item.mobile}
                    </if>
                </foreach>
            </trim>
            <trim prefix="`request_uri` = case" suffix="end,">
                <foreach collection="list" item="item" index="index">
                    <if test="null != item.requestUri and '' != item.requestUri">
                        WHEN `business_id` = #{item.businessId} THEN #{item.requestUri}
                    </if>
                </foreach>
            </trim>
            <trim prefix="`referer` = case" suffix="end,">
                <foreach collection="list" item="item" index="index">
                    <if test="null != item.referer and '' != item.referer">
                        WHEN `business_id` = #{item.businessId} THEN #{item.referer}
                    </if>
                </foreach>
            </trim>
            <trim prefix="`title` = case" suffix="end,">
                <foreach collection="list" item="item" index="index">
                    <if test="null != item.title and '' != item.title">
                        WHEN `business_id` = #{item.businessId} THEN #{item.title}
                    </if>
                </foreach>
            </trim>
            <trim prefix="`error_msg` = case" suffix="end,">
                <foreach collection="list" item="item" index="index">
                    <if test="null != item.errorMsg and '' != item.errorMsg">
                        WHEN `business_id` = #{item.businessId} THEN #{item.errorMsg}
                    </if>
                </foreach>
            </trim>
            <trim prefix="`error_cause` = case" suffix="end,">
                <foreach collection="list" item="item" index="index">
                    <if test="null != item.errorCause and '' != item.errorCause">
                        WHEN `business_id` = #{item.businessId} THEN #{item.errorCause}
                    </if>
                </foreach>
            </trim>
            <trim prefix="`is_success` = case" suffix="end,">
                <foreach collection="list" item="item" index="index">
                    <if test="null != item.success">
                        WHEN `business_id` = #{item.businessId} THEN #{item.success}
                    </if>
                </foreach>
            </trim>
            <trim prefix="`username` = case" suffix="end,">
                <foreach collection="list" item="item" index="index">
                    <if test="null != item.username and '' != item.username">
                        WHEN `business_id` = #{item.businessId} THEN #{item.username}
                    </if>
                </foreach>
            </trim>
        </trim>
        <where>
            `business_id` IN
            <foreach collection="list" index="index" item="item" separator="," open="(" close=")">
                #{item.businessId}
            </foreach>
        </where>
    </update>

    <!-- 根据业务id(businessId)查找API操作日志 -->
    <select id="getLogOp" resultType="com.doudoudrive.common.model.pojo.LogOp" resultMap="logOpResultMap">
        SELECT
        <include refid="logOp"/>
        FROM `log_op`
        <where>
            `business_id` = #{businessId};
        </where>
    </select>

    <!-- 根据Model中某个成员变量名称(非数据表中column的名称)查找(value需符合unique约束) -->
    <select id="getLogOpToModel" resultType="com.doudoudrive.common.model.pojo.LogOp" resultMap="logOpResultMap">
        SELECT
        <include refid="logOp"/>
        FROM `log_op`
        <where>
            `${modelName}` = #{value};
        </where>
    </select>

    <!-- 根据业务id(businessId)批量查找API操作日志 -->
    <select id="listLogOp" resultType="com.doudoudrive.common.model.pojo.LogOp" resultMap="logOpResultMap">
        SELECT
        <include refid="logOp"/>
        FROM `log_op`
        <where>
            `business_id` IN
            <foreach collection="list" index="index" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </where>
    </select>

    <!-- 指定条件查找API操作日志 -->
    <select id="listLogOpToKey" resultType="com.doudoudrive.common.model.pojo.LogOp" resultMap="logOpResultMap">
        SELECT
        <include refid="logOp"/>
        FROM `log_op`
        <trim prefix="WHERE" prefixOverrides="AND" suffixOverrides="AND">
            <include refid="searchCondition"/>
        </trim>
        ${limit};
    </select>

    <!-- 返回搜索的总数 -->
    <select id="countSearch" resultType="java.lang.Long">
        SELECT COUNT(*) FROM `log_op`
        <trim prefix="WHERE" prefixOverrides="AND" suffixOverrides="AND">
            <include refid="searchCondition"/>
        </trim>
    </select>

</mapper>
